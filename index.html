<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Task Dashboard (Google Sheets)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // **************************************************************************
        //    üëá URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) üëá
        // **************************************************************************
        
        const API_URL = "https://script.google.com/macros/s/AKfycbz0VehS_aSVDjdyPD1WgTMheA7Q0ny_ehq190eklxo0kYjPscHHas9f60_nqJmXj2jD/exec"; 
        
        // **************************************************************************


        const { useState, useMemo, useEffect } = React;

        // --- Icons ---
        const Icon = ({ name, className }) => {
            const icons = {
                Plus: <path d="M12 5v14M5 12h14" />,
                Clock: <path d="M12 6v6l4 2" />, 
                AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01" />,
                AlertCircle: <path d="M12 8v4M12 16h.01" />, 
                Search: <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
                Filter: <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
                Inbox: <path d="M22 12h-6l-2 3h-4l-2-3H2" />,
                X: <path d="M18 6L6 18M6 6l12 12" />,
                Calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />,
                User: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />,
                Tag: <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />,
                CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />,
                Check: <path d="M20 6L9 17l-5-5" />,
                Trash2: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
                ListPlus: <path d="M11 12H3M16 6H3M16 18H3M18 9v6M21 12h-6" />,
                CalendarDays: <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />,
                Refresh: <path d="M23 4v6h-6M1 20v-6h6" />, 
                Loader: <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" />,
                Archive: <path d="M21 8v13H3V8M1 3h22v5H1zM10 12h4" />,
                ArrowRight: <path d="M5 12h14M12 5l7 7-7 7" />,
                Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />,
                Eye: <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />,
                EyeCircle: <circle cx="12" cy="12" r="3" />,
                ChevronDown: <path d="M6 9l6 6 6-6"/>,
                ChevronUp: <path d="M18 15l-6-6-6 6"/>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                    {name === 'Clock' && <circle cx="12" cy="12" r="10" />}
                    {name === 'AlertCircle' && <circle cx="12" cy="12" r="10" />}
                    {name === 'Calendar' && <><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>}
                    {name === 'CalendarDays' && <><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="M8 14h.01" /><path d="M12 14h.01" /><path d="M16 14h.01" /><path d="M8 18h.01" /><path d="M12 18h.01" /><path d="M16 18h.01" /></>}
                    {name === 'User' && <circle cx="12" cy="7" r="4" />}
                    {name === 'Tag' && <line x1="7" y1="7" x2="7.01" y2="7" />}
                    {name === 'CheckCircle' && <polyline points="22 4 12 14.01 9 11.01" />}
                    {name === 'Inbox' && <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" />}
                    {name === 'Refresh' && <><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" /></>}
                    {name === 'Save' && <><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>}
                    {name === 'Eye' && <circle cx="12" cy="12" r="3" />}
                    {name === 'Edit' && <><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>}
                </svg>
            );
        };

        const StatCard = ({ title, count, type, iconName }) => {
            const styles = {
                default: { bg: 'bg-white', border: 'border-l-4 border-l-slate-400', text: 'text-slate-700', iconColor: 'text-slate-400', shadow: 'shadow-sm' },
                blue: { bg: 'bg-indigo-50', border: 'border-l-4 border-l-indigo-500', text: 'text-indigo-700', iconColor: 'text-indigo-500', shadow: 'shadow-indigo-100' },
                yellow: { bg: 'bg-amber-50', border: 'border-l-4 border-l-amber-500', text: 'text-amber-700', iconColor: 'text-amber-500', shadow: 'shadow-amber-100' },
                red: { bg: 'bg-rose-50', border: 'border-l-4 border-l-rose-500', text: 'text-rose-700', iconColor: 'text-rose-500', shadow: 'shadow-rose-100' },
                green: { bg: 'bg-emerald-50', border: 'border-l-4 border-l-emerald-500', text: 'text-emerald-700', iconColor: 'text-emerald-500', shadow: 'shadow-emerald-100' },
            };
            const style = styles[type] || styles.default;
            
            return (
                <div className={`bg-white rounded-xl p-4 flex flex-col justify-between h-32 ${style.shadow} shadow-lg transition-transform hover:-translate-y-1 duration-200 border border-slate-100 ${style.border}`}>
                    <div className="flex justify-between items-start">
                        <span className={`text-sm font-bold uppercase tracking-wider ${type === 'default' ? 'text-slate-500' : style.text}`}>{title}</span>
                        <div className={`p-2 rounded-lg ${style.bg}`}>
                            {iconName && <Icon name={iconName} className={`w-6 h-6 ${style.iconColor}`} />}
                        </div>
                    </div>
                    <div className={`text-4xl font-black ${style.text}`}>{count}</div>
                </div>
            );
        };

        const CalendarView = ({ startDate, dueDate }) => {
            if (!startDate || !dueDate) return null;

            const start = new Date(startDate);
            const end = new Date(dueDate);
            
            const [currentMonth, setCurrentMonth] = useState(new Date(start.getFullYear(), start.getMonth(), 1));

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfWeek = new Date(year, month, 1).getDay(); // 0 = Sun

            const days = [];
            for (let i = 0; i < firstDayOfWeek; i++) {
                days.push(<div key={`pad-${i}`} className="h-10"></div>);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const checkTime = new Date(year, month, d).setHours(0,0,0,0);
                const sTime = new Date(start).setHours(0,0,0,0);
                const eTime = new Date(end).setHours(0,0,0,0);
                const todayTime = new Date().setHours(0,0,0,0);

                let bgClass = "hover:bg-indigo-50 text-slate-700";
                let roundedClass = "rounded-lg";
                let textClass = "";
                let borderClass = checkTime === todayTime ? "ring-2 ring-indigo-400 font-bold text-indigo-600" : "";

                if (checkTime >= sTime && checkTime <= eTime) {
                    bgClass = "bg-indigo-600 text-white shadow-md shadow-indigo-200";
                    roundedClass = ""; 
                    textClass = "font-bold";
                    
                    if (sTime === eTime) {
                         roundedClass = "rounded-full";
                    } else {
                        if (checkTime === sTime) roundedClass = "rounded-l-full";
                        if (checkTime === eTime) roundedClass = "rounded-r-full";
                    }
                }

                days.push(
                    <div key={d} className={`h-10 flex items-center justify-center text-sm relative transition-all ${bgClass} ${roundedClass} ${borderClass} ${textClass}`}>
                        {d}
                    </div>
                );
            }

            const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

            return (
                <div className="bg-white border border-slate-200 rounded-2xl p-5 mt-6 shadow-xl shadow-slate-200/50">
                    <div className="flex justify-between items-center mb-6">
                         <button onClick={() => setCurrentMonth(new Date(year, month - 1, 1))} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors">
                             <Icon name="ArrowRight" className="w-5 h-5 rotate-180" />
                         </button>
                         <div className="font-extrabold text-slate-800 text-xl tracking-tight">
                             {monthNames[month]} {year + 543}
                         </div>
                         <button onClick={() => setCurrentMonth(new Date(year, month + 1, 1))} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors">
                             <Icon name="ArrowRight" className="w-5 h-5" />
                         </button>
                    </div>
                    
                    <div className="grid grid-cols-7 gap-1 text-center mb-3">
                        {['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'].map(day => (
                            <div key={day} className="text-xs font-bold text-slate-400 uppercase tracking-wide">{day}</div>
                        ))}
                    </div>
                    
                    <div className="grid grid-cols-7 gap-y-2">
                        {days}
                    </div>
                </div>
            );
        };

        const TaskDetailModal = ({ task, onClose }) => {
            if (!task) return null;
            
            const formatDateTime = (dateString) => {
                if (!dateString) return '-';
                return new Date(dateString).toLocaleDateString('th-TH', { 
                    day: 'numeric', month: 'long', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
            };

            return (
                <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh] ring-1 ring-white/20">
                        <div className="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-5 flex justify-between items-center text-white">
                            <h3 className="font-bold text-xl flex items-center gap-2 tracking-tight">
                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
                            </h3>
                            <button onClick={onClose} className="hover:bg-white/10 p-1.5 rounded-full transition-colors"><Icon name="X" className="w-6 h-6"/></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto">
                            <div className="mb-6">
                                <h2 className="text-2xl font-black text-slate-800 mb-2 leading-tight">{task.topic}</h2>
                                <div className="flex flex-wrap gap-2 text-sm font-medium">
                                    <span className="flex items-center gap-1 bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full"><Icon name="User" className="w-4 h-4"/> {task.assignee}</span>
                                    <span className="flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-1 rounded-full"><Icon name="Tag" className="w-4 h-4"/> {task.partNo || '-'} {task.partName}</span>
                                </div>
                            </div>

                            <div className="space-y-4 text-sm">
                                <div>
                                    <label className="block text-slate-400 text-xs font-bold uppercase mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                    <p className="text-slate-700 bg-slate-50 p-4 rounded-xl border border-slate-100 leading-relaxed">{task.details || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</p>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                        <label className="block text-blue-500 text-xs font-bold uppercase mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                        <div className="font-bold text-blue-900">{formatDateTime(task.startDate)}</div>
                                    </div>
                                    <div className="bg-rose-50 p-3 rounded-xl border border-rose-100">
                                        <label className="block text-rose-500 text-xs font-bold uppercase mb-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                                        <div className="font-bold text-rose-900">{formatDateTime(task.dueDate)}</div>
                                    </div>
                                </div>
                            </div>

                            <CalendarView startDate={task.startDate} dueDate={task.dueDate} />
                        </div>
                    </div>
                </div>
            );
        };

        const EditTaskModal = ({ task, isOpen, onClose, onSave, isSaving }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (task) {
                    setFormData({
                        ...task,
                        meetingDate: task.meetingDate ? new Date(task.meetingDate).toISOString().split('T')[0] : '',
                        startDate: task.startDate ? new Date(task.startDate).toISOString().slice(0, 16) : '',
                        dueDate: task.dueDate ? new Date(task.dueDate).toISOString().slice(0, 16) : ''
                    });
                }
            }, [task]);

            if (!isOpen || !task) return null;

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = () => {
                onSave(task.id, formData);
            };

            return (
                <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-gradient-to-r from-amber-500 to-orange-600 px-6 py-5 flex justify-between items-center text-white shadow-md">
                            <h3 className="font-bold text-xl flex items-center gap-2"><Icon name="Edit" className="w-6 h-6"/> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</h3>
                            <button onClick={onClose} className="hover:bg-white/20 p-1.5 rounded-full transition-colors"><Icon name="X" className="w-6 h-6"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ *</label><input name="topic" value={formData.topic || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° *</label><input type="date" name="meetingDate" value={formData.meetingDate || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö *</label><input name="assignee" value={formData.assignee || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-sm font-bold text-slate-600 mb-1 block">Part No.</label><input name="partNo" value={formData.partNo || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                                <div><label className="text-sm font-bold text-slate-600 mb-1 block">Part Name</label><input name="partName" value={formData.partName || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="datetime-local" name="startDate" value={formData.startDate || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                                <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label><input type="datetime-local" name="dueDate" value={formData.dueDate || ''} onChange={handleChange} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" /></div>
                            </div>
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea name="details" value={formData.details || ''} onChange={handleChange} rows="3" className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"></textarea></div>
                        </div>
                        <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-slate-50">
                            <button onClick={onClose} className="px-5 py-2.5 text-slate-600 font-bold hover:bg-slate-200 rounded-lg transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button onClick={handleSubmit} disabled={isSaving} className="px-6 py-2.5 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white rounded-lg shadow-lg font-bold flex items-center gap-2">
                                {isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : <><Icon name="Save" className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddTaskModal = ({ isOpen, onClose, onSubmit, isSaving }) => {
            const [topic, setTopic] = useState('');
            const [meetingDate, setMeetingDate] = useState(new Date().toISOString().split('T')[0]);
            const [pendingItems, setPendingItems] = useState([]);
            
            const [currentItem, setCurrentItem] = useState({ 
                partNo: '', 
                partName: '', 
                assignee: '', 
                startDate: '', 
                dueDate: '', 
                details: '' 
            });

            if (!isOpen) return null;

            const isResidueInput = () => {
                if (pendingItems.length === 0) return false;
                return !currentItem.partNo && !currentItem.partName && !currentItem.details;
            };

            const handleAddItem = () => {
                if (!currentItem.assignee || !currentItem.startDate || !currentItem.dueDate) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return;
                }
                setPendingItems(prev => [...prev, { ...currentItem, tempId: Date.now().toString() + Math.random().toString().slice(2) }]);
                setCurrentItem({ ...currentItem, partNo: '', partName: '', details: '' }); 
            };

            const handleSubmitAll = () => {
                if (!topic || !meetingDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°'); return; }
                let finalItems = [...pendingItems];
                const hasValidInput = currentItem.assignee && currentItem.startDate && currentItem.dueDate;
                
                if (hasValidInput && !isResidueInput()) {
                    finalItems.push({ ...currentItem, tempId: Date.now().toString() + Math.random().toString().slice(2) });
                }

                if (finalItems.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

                const tasks = finalItems.map((item, index) => ({
                    id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9) + '-' + index,
                    topic, meetingDate, ...item,
                    status: 'active', completedAt: '', createdAt: new Date().toISOString()
                }));
                onSubmit(tasks);
                setTopic(''); setPendingItems([]); onClose();
            };

            const hasValidInput = currentItem.assignee && currentItem.startDate && currentItem.dueDate;
            const willAddCurrent = hasValidInput && !isResidueInput();
            const totalCount = pendingItems.length + (willAddCurrent ? 1 : 0);

            return (
                <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-3xl w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        {/* Vibrant Header */}
                        <div className="bg-gradient-to-r from-indigo-600 to-violet-600 px-6 py-5 flex justify-between items-center text-white shadow-md">
                            <h3 className="font-bold text-xl flex items-center gap-2"><Icon name="Plus" className="w-6 h-6"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
                            <button onClick={onClose} className="hover:bg-white/20 p-1.5 rounded-full transition-colors"><Icon name="X" className="w-6 h-6"/></button>
                        </div>
                        <div className="flex flex-col md:flex-row h-full overflow-hidden">
                            <div className="w-full md:w-5/12 p-6 overflow-y-auto border-r border-slate-100 bg-slate-50">
                                <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><span className="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
                                <div className="space-y-4">
                                    <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ *</label><input value={topic} onChange={e=>setTopic(e.target.value)} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" /></div>
                                    <div><label className="text-sm font-bold text-slate-600 mb-1 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° *</label><input type="date" value={meetingDate} onChange={e=>setMeetingDate(e.target.value)} className="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" /></div>
                                </div>
                                <hr className="my-6 border-slate-200"/>
                                <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><span className="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h4>
                                <div className="space-y-3">
                                    <input placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö *" value={currentItem.assignee} onChange={e=>setCurrentItem({...currentItem, assignee: e.target.value})} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input placeholder="Part No." value={currentItem.partNo} onChange={e=>setCurrentItem({...currentItem, partNo: e.target.value})} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                        <input placeholder="Part Name" value={currentItem.partName} onChange={e=>setCurrentItem({...currentItem, partName: e.target.value})} className="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    </div>
                                    <div className="grid grid-cols-1 gap-3">
                                        <div className="bg-blue-50 p-2 rounded-lg border border-blue-100">
                                            <label className="text-xs font-bold text-blue-700 block mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤)</label>
                                            <input type="datetime-local" value={currentItem.startDate} onChange={e=>setCurrentItem({...currentItem, startDate: e.target.value})} className="w-full p-1.5 bg-white border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-400 outline-none" />
                                        </div>
                                        <div className="bg-rose-50 p-2 rounded-lg border border-rose-100">
                                            <label className="text-xs font-bold text-rose-700 block mb-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤)</label>
                                            <input type="datetime-local" value={currentItem.dueDate} onChange={e=>setCurrentItem({...currentItem, dueDate: e.target.value})} className="w-full p-1.5 bg-white border border-rose-200 rounded text-sm focus:ring-2 focus:ring-rose-400 outline-none" />
                                        </div>
                                    </div>
                                    <textarea placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." value={currentItem.details} onChange={e=>setCurrentItem({...currentItem, details: e.target.value})} rows="2" className="w-full p-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></textarea>
                                    <button onClick={handleAddItem} className="w-full py-2.5 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-sm font-bold shadow-lg flex justify-center items-center gap-2 transition-all transform active:scale-95"><Icon name="ListPlus" className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                                </div>
                            </div>
                            <div className="w-full md:w-7/12 flex flex-col bg-white">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><h4 className="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ({pendingItems.length})</h4></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                    {pendingItems.map((item, idx) => (
                                        <div key={item.tempId} className="flex gap-4 p-4 border border-slate-100 rounded-xl bg-white shadow-sm hover:shadow-md transition-shadow">
                                            <span className="font-black text-indigo-500 text-lg opacity-30">#{idx+1}</span>
                                            <div className="flex-1 text-sm">
                                                <div className="font-bold text-slate-800 text-base mb-1">{item.assignee}</div>
                                                <div className="text-xs font-medium text-slate-500 bg-slate-100 inline-block px-2 py-0.5 rounded">{item.partNo} {item.partName}</div>
                                                <div className="text-xs font-bold text-rose-500 mt-2 flex items-center gap-1"><Icon name="Clock" className="w-3 h-3"/> ‡∏™‡πà‡∏á: {new Date(item.dueDate).toLocaleString('th-TH')}</div>
                                            </div>
                                            <button onClick={()=>setPendingItems(prev=>prev.filter(i=>i.tempId!==item.tempId))} className="text-slate-300 hover:text-rose-500 transition-colors"><Icon name="Trash2" className="w-5 h-5"/></button>
                                        </div>
                                    ))}
                                    {pendingItems.length === 0 && (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                                            <Icon name="Inbox" className="w-16 h-16 mb-2" />
                                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-slate-100 flex justify-end gap-3 bg-white">
                                    <button onClick={onClose} className="px-5 py-2.5 text-slate-600 font-bold hover:bg-slate-100 rounded-lg transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={handleSubmitAll} disabled={isSaving} className="px-8 py-2.5 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white rounded-lg shadow-lg shadow-indigo-200 font-bold flex items-center gap-2 transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                                        {isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : <><Icon name="CheckCircle" className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({totalCount})</>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Topic Group Component ---
        const TopicGroup = ({ topicName, tasks, onArchive, onToggle, onViewDetail, onEdit }) => {
            const [isExpanded, setIsExpanded] = useState(true);

            // Calculate progress
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'completed').length;
            const progress = total === 0 ? 0 : Math.round((completed / total) * 100);
            
            // Get date from first task (assuming grouped by topic name, date might vary but we show one)
            const meetingDate = tasks[0]?.meetingDate;
            const formatDateOnly = (d) => d ? new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }) : '-';
            const formatDateTime = (d) => d ? new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }) : '-';

            const getStatusInfo = (t) => {
                if (t.status === 'completed') return { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' };
                const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                const diff = Math.ceil((due - new Date().setHours(0,0,0,0)) / (86400000));
                if (diff < 0) return { bg: 'bg-rose-50', text: 'text-rose-700', border: 'border-rose-200', label: `‡πÄ‡∏•‡∏¢ ${Math.abs(diff)} ‡∏ß‡∏±‡∏ô` };
                if (diff <= 3) return { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200', label: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô` };
                return { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200', label: '‡∏õ‡∏Å‡∏ï‡∏¥' };
            };

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-6 transition-all hover:shadow-md">
                    {/* Header */}
                    <div 
                        className="bg-slate-50 p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-start md:items-center cursor-pointer select-none"
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        <div className="flex items-center gap-4 flex-1">
                            <button className="text-slate-400 hover:text-indigo-600 transition-colors">
                                {isExpanded ? <Icon name="ChevronUp" className="w-5 h-5"/> : <Icon name="ChevronDown" className="w-5 h-5"/>}
                            </button>
                            <div>
                                <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                    {topicName}
                                    <span className="text-xs font-normal bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">{total} ‡∏á‡∏≤‡∏ô</span>
                                </h3>
                                <div className="text-sm text-slate-500 flex items-center gap-2 mt-1">
                                    <Icon name="CalendarDays" className="w-4 h-4"/> 
                                    ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°: {formatDateOnly(meetingDate)}
                                </div>
                            </div>
                        </div>

                        <div className="mt-4 md:mt-0 flex items-center gap-4 w-full md:w-auto">
                            <div className="flex-1 md:w-48">
                                <div className="flex justify-between text-xs mb-1 font-bold text-slate-500">
                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                                    <span>{progress}%</span>
                                </div>
                                <div className="w-full bg-slate-200 rounded-full h-2">
                                    <div 
                                        className={`h-2 rounded-full transition-all duration-500 ${progress === 100 ? 'bg-emerald-500' : 'bg-indigo-500'}`} 
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Task List */}
                    {isExpanded && (
                        <div className="p-4 space-y-3 bg-white">
                            {tasks.map((task) => {
                                const s = getStatusInfo(task);
                                const isNoId = String(task.id).startsWith('no-id-');
                                return (
                                    <div key={task.id} className={`flex flex-col md:flex-row items-start md:items-center gap-4 p-4 rounded-xl border border-slate-100 hover:border-indigo-100 hover:bg-slate-50/50 transition-colors ${task.status==='completed' ? 'opacity-70 bg-slate-50' : ''}`}>
                                        
                                        {/* Status Checkbox */}
                                        <div className="pt-1 md:pt-0">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onToggle(task); }} 
                                                className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all shadow-sm ${task.status==='completed' ? 'bg-emerald-500 text-white shadow-emerald-200' : 'bg-white border-2 border-slate-200 text-slate-300 hover:border-indigo-500 hover:text-indigo-500'}`}
                                            >
                                                <Icon name="Check" className="w-6 h-6" />
                                            </button>
                                            {isNoId && (
                                                <div className="flex justify-center mt-1">
                                                     <span className="w-2 h-2 rounded-full bg-amber-400 animate-pulse" title="Syncing..."></span>
                                                </div>
                                            )}
                                        </div>

                                        {/* Content */}
                                        <div className="flex-1 min-w-0">
                                            <div className="flex flex-wrap gap-2 mb-1">
                                                <span className="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-md font-bold flex items-center gap-1">
                                                    <Icon name="User" className="w-3 h-3"/> {task.assignee}
                                                </span>
                                                {(task.partNo || task.partName) && (
                                                    <span className="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-md font-medium">
                                                       PART: {task.partNo} {task.partName}
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {/* Dates */}
                                            <div className="flex items-center gap-2 text-xs text-slate-500 mt-2">
                                                <span className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100 font-medium">‡πÄ‡∏£‡∏¥‡πà‡∏°: {formatDateTime(task.startDate)}</span>
                                                <Icon name="ArrowRight" className="w-3 h-3 text-slate-300"/>
                                                <span className="bg-rose-50 text-rose-700 px-2 py-0.5 rounded border border-rose-100 font-medium">‡∏™‡πà‡∏á: {formatDateTime(task.dueDate)}</span>
                                            </div>

                                            {task.details && <p className="text-sm text-slate-400 mt-2 line-clamp-1">{task.details}</p>}
                                        </div>

                                        {/* Actions */}
                                        <div className="flex items-center gap-3 w-full md:w-auto justify-between md:justify-end border-t md:border-t-0 border-slate-100 pt-3 md:pt-0 mt-2 md:mt-0">
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold border ${s.bg} ${s.text} ${s.border}`}>{s.label}</span>
                                            
                                            <div className="flex gap-1">
                                                <button onClick={() => onViewDetail(task)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors">
                                                    <Icon name="Eye" className="w-5 h-5"/>
                                                </button>
                                                <button onClick={() => onEdit(task)} className="p-2 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-full transition-colors">
                                                    <Icon name="Edit" className="w-5 h-5"/>
                                                </button>
                                                <button onClick={() => onArchive(task.id)} className="p-2 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-full transition-colors">
                                                    <Icon name="Trash2" className="w-5 h-5"/>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null); 
            const [editingTask, setEditingTask] = useState(null); // For edit modal
            
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');

            const [deletedLocalIds, setDeletedLocalIds] = useState(() => {
                const saved = localStorage.getItem('deletedLocalIds');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('deletedLocalIds', JSON.stringify(deletedLocalIds));
            }, [deletedLocalIds]);

            const fetchTasks = async () => {
                if (API_URL.includes("‡∏ß‡∏≤‡∏á_URL_‡∏¢‡∏≤‡∏ß‡πÜ")) { 
                    console.log("Waiting for API URL...");
                    setIsLoading(false); 
                    return; 
                } 
                
                setIsLoading(true);
                try {
                    const res = await fetch(API_URL);
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        const safeData = data
                            .filter(item => {
                                const status = String(item.status || '').toLowerCase().trim();
                                return status !== 'archived';
                            })
                            .map((item, index) => ({
                                ...item,
                                id: (item.id && String(item.id).trim() !== '') ? String(item.id) : `no-id-${index}`
                            }))
                            .filter(item => !deletedLocalIds.includes(item.id));
                            
                        setTasks(safeData.reverse());
                    }
                } catch (error) {
                    console.error("Error fetching:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { fetchTasks(); }, []);

            const handleAddTasks = async (newTasks) => {
                setIsSaving(true);
                setTasks(prev => [...newTasks, ...prev]);

                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'create', tasks: newTasks })
                    });
                    setTimeout(fetchTasks, 2000); 
                } catch (error) {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleUpdateTask = async (id, updatedFields) => {
                setIsSaving(true);
                
                // Update local state immediately
                setTasks(prev => prev.map(t => t.id === id ? { ...t, ...updatedFields } : t));
                setEditingTask(null); // Close modal

                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'update', id: id, updates: updatedFields })
                    });
                } catch (error) {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleArchiveTask = async (id) => {
                const isNoId = String(id).startsWith('no-id-');
                
                if (!window.confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                
                setTasks(prev => prev.filter(t => t.id !== id));
                
                if (isNoId) {
                    setDeletedLocalIds(prev => [...prev, id]);
                    return;
                }

                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'update', id: id, updates: { status: 'archived' } })
                });
            };

            const handleToggleComplete = async (task) => {
                const newStatus = task.status === 'completed' ? 'active' : 'completed';
                const completedAt = newStatus === 'completed' ? new Date().toISOString() : '';
                const isNoId = String(task.id).startsWith('no-id-');
                
                if (isNoId) {
                    setDeletedLocalIds(prev => [...prev, task.id]);
                    setTasks(prev => prev.filter(t => t.id !== task.id)); 

                    const newTask = {
                        ...task,
                        id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                        status: newStatus,
                        completedAt: completedAt
                    };

                    setTasks(prev => [newTask, ...prev]);

                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'create', tasks: [newTask] })
                    });
                    return;
                }

                setTasks(prev => prev.map(t => String(t.id) === String(task.id) ? { ...t, status: newStatus, completedAt } : t));
                
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'update', id: task.id, updates: { status: newStatus, completedAt: completedAt } })
                });
            };

            const stats = useMemo(() => {
                const now = new Date(); now.setHours(0,0,0,0);
                let c = { all: 0, normal: 0, nearDue: 0, overdue: 0, completed: 0 };
                tasks.forEach(t => {
                    const status = String(t.status || '').toLowerCase();
                    if (status === 'archived') return; 
                    
                    c.all++;
                    if (status === 'completed') { c.completed++; return; }
                    const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                    const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) c.overdue++; else if (diffDays <= 3) c.nearDue++; else c.normal++;
                });
                return c;
            }, [tasks]);

            // Filter tasks first
            const filteredTasks = tasks.filter(t => {
                const status = String(t.status || '').toLowerCase();
                if (status === 'archived') return false; 
                
                const matches = (t.topic+t.assignee+t.partNo+t.partName).toLowerCase().includes(searchTerm.toLowerCase());
                if (filterStatus === 'all') return matches;
                if (filterStatus === 'completed') return matches && status === 'completed';
                return matches && status !== 'completed';
            });

            // Group tasks by Topic
            const groupedTasks = useMemo(() => {
                return filteredTasks.reduce((acc, task) => {
                    const key = task.topic;
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(task);
                    return acc;
                }, {});
            }, [filteredTasks]);

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-900 p-6 md:p-10 relative">
                    {/* Loading Overlay */}
                    {isLoading && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center loading-overlay">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center">
                                <Icon name="Loader" className="w-12 h-12 text-indigo-600 animate-spin mb-4" />
                                <p className="text-slate-500 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                            </div>
                        </div>
                    )}

                    {API_URL.includes("‡∏ß‡∏≤‡∏á_URL_‡∏¢‡∏≤‡∏ß‡πÜ") && (
                        <div className="bg-rose-100 border-l-4 border-rose-500 text-rose-700 px-4 py-4 rounded-r shadow-md animate-pulse mb-6">
                            <p className="font-bold text-lg">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet!</p>
                            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå index.html ‡∏î‡πâ‡∏ß‡∏¢ Notepad ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥ URL ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 37</p>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between mb-10 gap-6 items-end">
                        <div>
                            <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600 tracking-tight">Meeting Dashboard</h1>
                            <p className="text-slate-500 mt-2 font-medium flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
                                ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡∏° (Google Sheets)
                            </p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={fetchTasks} className="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-5 py-3 rounded-xl shadow-sm font-bold flex items-center gap-2 transition-transform hover:-translate-y-0.5">
                                <Icon name="Refresh" className={`w-5 h-5 ${isLoading ? 'animate-spin' : ''}`} /> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                            </button>
                            <button onClick={() => setIsAddModalOpen(true)} className="bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white px-6 py-3 rounded-xl shadow-lg shadow-indigo-200 font-bold flex items-center gap-2 transition-transform hover:-translate-y-0.5 active:translate-y-0">
                                <Icon name="Plus" className="w-6 h-6" /> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 mb-10">
                        <StatCard title="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" count={stats.all} type="default" />
                        <StatCard title="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" count={stats.completed} type="green" iconName="CheckCircle" />
                        <StatCard title="‡∏õ‡∏Å‡∏ï‡∏¥" count={stats.normal} type="blue" iconName="Clock" />
                        <StatCard title="‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î" count={stats.nearDue} type="yellow" iconName="AlertTriangle" />
                        <StatCard title="‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î" count={stats.overdue} type="red" iconName="AlertCircle" />
                    </div>

                    {/* Filter */}
                    <div className="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm mb-8 flex flex-col md:flex-row gap-4 items-center">
                        <div className="relative flex-1 w-full">
                            <div className="absolute left-4 top-3.5 text-slate-400"><Icon name="Search" className="w-5 h-5"/></div>
                            <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô, ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö, ‡∏´‡∏£‡∏∑‡∏≠ Part..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-3 rounded-xl border border-transparent bg-slate-50 focus:bg-white focus:border-indigo-300 focus:ring-4 focus:ring-indigo-50 outline-none transition-all font-medium" />
                        </div>
                        <div className="h-10 w-px bg-slate-200 hidden md:block"></div>
                        <select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="bg-transparent font-bold text-slate-600 outline-none px-4 py-2 cursor-pointer hover:text-indigo-600 transition-colors">
                            <option value="all">üìÅ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="active">‚ö° ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</option>
                            <option value="completed">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                        </select>
                    </div>

                    {/* Grouped List */}
                    <div className="space-y-6">
                        {Object.keys(groupedTasks).length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-80 text-slate-400 bg-white rounded-3xl shadow-sm border border-slate-100">
                                <div className="bg-slate-50 p-6 rounded-full mb-4">
                                    <Icon name="Inbox" className="w-16 h-16 opacity-50" />
                                </div>
                                <p className="font-bold text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</p>
                                <p className="text-sm">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</p>
                            </div>
                        ) : (
                            Object.entries(groupedTasks).map(([topic, tasks]) => (
                                <TopicGroup 
                                    key={topic} 
                                    topicName={topic} 
                                    tasks={tasks} 
                                    onArchive={handleArchiveTask}
                                    onToggle={handleToggleComplete}
                                    onViewDetail={setSelectedTask}
                                    onEdit={setEditingTask}
                                />
                            ))
                        )}
                    </div>

                    <AddTaskModal isOpen={isAddModalOpen} onClose={()=>setIsAddModalOpen(false)} onSubmit={handleAddTasks} isSaving={isSaving} />
                    <EditTaskModal task={editingTask} isOpen={!!editingTask} onClose={()=>setEditingTask(null)} onSave={handleUpdateTask} isSaving={isSaving} />
                    <TaskDetailModal task={selectedTask} onClose={() => setSelectedTask(null)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
