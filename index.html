<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Task Dashboard (Google Sheets)</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }
        /* Custom scrollbar for calendar if needed */
        .calendar-grid::-webkit-scrollbar { width: 4px; }
        .calendar-grid::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // **************************************************************************
        //    üëá URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ) üëá
        // **************************************************************************
        
        const API_URL = "https://script.google.com/macros/s/AKfycbz0VehS_aSVDjdyPD1WgTMheA7Q0ny_ehq190eklxo0kYjPscHHas9f60_nqJmXj2jD/exec"; 
        
        // **************************************************************************


        const { useState, useMemo, useEffect } = React;

        // --- Icons ---
        const Icon = ({ name, className }) => {
            const icons = {
                Plus: <path d="M12 5v14M5 12h14" />,
                Clock: <path d="M12 6v6l4 2" />, 
                AlertTriangle: <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01" />,
                AlertCircle: <path d="M12 8v4M12 16h.01" />, 
                Search: <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />,
                Filter: <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
                Inbox: <path d="M22 12h-6l-2 3h-4l-2-3H2" />,
                X: <path d="M18 6L6 18M6 6l12 12" />,
                Calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />,
                User: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />,
                Tag: <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />,
                CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />,
                Check: <path d="M20 6L9 17l-5-5" />,
                Trash2: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
                ListPlus: <path d="M11 12H3M16 6H3M16 18H3M18 9v6M21 12h-6" />,
                CalendarDays: <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />,
                Refresh: <path d="M23 4v6h-6M1 20v-6h6" />, 
                Loader: <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" />,
                Archive: <path d="M21 8v13H3V8M1 3h22v5H1zM10 12h4" />,
                ArrowRight: <path d="M5 12h14M12 5l7 7-7 7" />,
                Save: <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />,
                Eye: <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />,
                EyeCircle: <circle cx="12" cy="12" r="3" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                    {name === 'Clock' && <circle cx="12" cy="12" r="10" />}
                    {name === 'AlertCircle' && <circle cx="12" cy="12" r="10" />}
                    {name === 'Calendar' && <><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></>}
                    {name === 'CalendarDays' && <><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="M8 14h.01" /><path d="M12 14h.01" /><path d="M16 14h.01" /><path d="M8 18h.01" /><path d="M12 18h.01" /><path d="M16 18h.01" /></>}
                    {name === 'User' && <circle cx="12" cy="7" r="4" />}
                    {name === 'Tag' && <line x1="7" y1="7" x2="7.01" y2="7" />}
                    {name === 'CheckCircle' && <polyline points="22 4 12 14.01 9 11.01" />}
                    {name === 'Inbox' && <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" />}
                    {name === 'Refresh' && <><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" /></>}
                    {name === 'Save' && <><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>}
                    {name === 'Eye' && <circle cx="12" cy="12" r="3" />}
                </svg>
            );
        };

        const StatCard = ({ title, count, type, iconName }) => {
            const styles = {
                default: { bg: 'bg-white', border: 'border-gray-200', text: 'text-gray-900', iconColor: 'text-gray-400' },
                blue: { bg: 'bg-blue-50', border: 'border-blue-100', text: 'text-blue-600', iconColor: 'text-blue-500' },
                yellow: { bg: 'bg-yellow-50', border: 'border-yellow-100', text: 'text-yellow-700', iconColor: 'text-yellow-600' },
                red: { bg: 'bg-red-50', border: 'border-red-100', text: 'text-red-600', iconColor: 'text-red-500' },
                green: { bg: 'bg-green-50', border: 'border-green-100', text: 'text-green-600', iconColor: 'text-green-500' },
            };
            const style = styles[type] || styles.default;
            return (
                <div className={`${style.bg} border ${style.border} rounded-xl p-4 flex flex-col justify-between h-32 shadow-sm`}>
                    <div className="flex justify-between items-start">
                        <span className={`text-sm font-medium ${type === 'default' ? 'text-gray-500' : style.text}`}>{title}</span>
                        {iconName && <Icon name={iconName} className={`w-5 h-5 ${style.iconColor}`} />}
                    </div>
                    <div className={`text-4xl font-bold ${style.text}`}>{count}</div>
                </div>
            );
        };

        // --- NEW: Calendar Component for Task View ---
        const CalendarView = ({ startDate, dueDate }) => {
            if (!startDate || !dueDate) return null;

            const start = new Date(startDate);
            const end = new Date(dueDate);
            
            // Show month of start date initially
            const [currentMonth, setCurrentMonth] = useState(new Date(start.getFullYear(), start.getMonth(), 1));

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfWeek = new Date(year, month, 1).getDay(); // 0 = Sun

            const days = [];
            // Padding for prev month
            for (let i = 0; i < firstDayOfWeek; i++) {
                days.push(<div key={`pad-${i}`} className="h-10"></div>);
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const currentDate = new Date(year, month, d);
                // Check comparisons at start-of-day level
                const checkTime = new Date(year, month, d).setHours(0,0,0,0);
                const sTime = new Date(start).setHours(0,0,0,0);
                const eTime = new Date(end).setHours(0,0,0,0);
                const todayTime = new Date().setHours(0,0,0,0);

                let bgClass = "hover:bg-gray-50 text-gray-700";
                let roundedClass = "rounded-lg"; // Default loose
                let borderClass = checkTime === todayTime ? "border-2 border-blue-500" : "";

                // Highlight Logic
                if (checkTime >= sTime && checkTime <= eTime) {
                    bgClass = "bg-blue-100 text-blue-700 font-bold shadow-sm";
                    roundedClass = ""; // Connect them
                    
                    // Single day event
                    if (sTime === eTime) {
                         roundedClass = "rounded-full";
                    } else {
                        if (checkTime === sTime) roundedClass = "rounded-l-full";
                        if (checkTime === eTime) roundedClass = "rounded-r-full";
                        if (checkTime > sTime && checkTime < eTime) roundedClass = ""; // Middle
                    }
                }

                days.push(
                    <div key={d} className={`h-10 flex items-center justify-center text-sm relative transition-all ${bgClass} ${roundedClass} ${borderClass}`}>
                        {d}
                    </div>
                );
            }

            const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

            return (
                <div className="bg-white border border-gray-200 rounded-xl p-4 mt-6 shadow-sm">
                    <div className="flex justify-between items-center mb-4">
                         <button onClick={() => setCurrentMonth(new Date(year, month - 1, 1))} className="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                             <Icon name="ArrowRight" className="w-5 h-5 rotate-180" />
                         </button>
                         <div className="font-bold text-gray-800 text-lg">
                             {monthNames[month]} {year + 543}
                         </div>
                         <button onClick={() => setCurrentMonth(new Date(year, month + 1, 1))} className="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                             <Icon name="ArrowRight" className="w-5 h-5" />
                         </button>
                    </div>
                    
                    <div className="grid grid-cols-7 gap-1 text-center mb-2">
                        {['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'].map(day => (
                            <div key={day} className="text-xs font-semibold text-gray-400">{day}</div>
                        ))}
                    </div>
                    
                    <div className="grid grid-cols-7 gap-y-1">
                        {days}
                    </div>

                    <div className="mt-4 pt-3 border-t flex justify-center gap-4 text-xs text-gray-500">
                        <div className="flex items-center gap-1">
                            <div className="w-3 h-3 bg-blue-100 rounded-full"></div> <span>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô</span>
                        </div>
                        <div className="flex items-center gap-1">
                            <div className="w-3 h-3 border-2 border-blue-500 rounded-full"></div> <span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskDetailModal = ({ task, onClose }) => {
            if (!task) return null;
            
            const formatDateTime = (dateString) => {
                if (!dateString) return '-';
                return new Date(dateString).toLocaleDateString('th-TH', { 
                    day: 'numeric', month: 'long', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-gray-900 px-6 py-4 flex justify-between items-center text-white">
                            <h3 className="font-semibold text-lg flex items-center gap-2">
                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô
                            </h3>
                            <button onClick={onClose} className="hover:bg-gray-700 p-1 rounded-full"><Icon name="X" className="w-6 h-6"/></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto">
                            <div className="mb-4">
                                <h2 className="text-xl font-bold text-gray-900 mb-1">{task.topic}</h2>
                                <div className="flex flex-wrap gap-2 text-sm text-gray-500">
                                    <span className="flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded"><Icon name="User" className="w-3 h-3"/> {task.assignee}</span>
                                    <span className="flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded"><Icon name="Tag" className="w-3 h-3"/> {task.partNo || '-'} {task.partName}</span>
                                </div>
                            </div>

                            <div className="space-y-3 text-sm">
                                <div>
                                    <label className="block text-gray-400 text-xs">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                    <p className="text-gray-700 bg-gray-50 p-3 rounded-lg mt-1">{task.details || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}</p>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-gray-400 text-xs mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                                        <div className="font-medium">{formatDateTime(task.startDate)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-gray-400 text-xs mb-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                                        <div className="font-medium text-red-600">{formatDateTime(task.dueDate)}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Calendar Visualization */}
                            <CalendarView startDate={task.startDate} dueDate={task.dueDate} />
                        </div>
                    </div>
                </div>
            );
        };

        const AddTaskModal = ({ isOpen, onClose, onSubmit, isSaving }) => {
            const [topic, setTopic] = useState('');
            const [meetingDate, setMeetingDate] = useState(new Date().toISOString().split('T')[0]);
            const [pendingItems, setPendingItems] = useState([]);
            
            const [currentItem, setCurrentItem] = useState({ 
                partNo: '', 
                partName: '', 
                assignee: '', 
                startDate: '', 
                dueDate: '', 
                details: '' 
            });

            if (!isOpen) return null;

            const isResidueInput = () => {
                if (pendingItems.length === 0) return false;
                return !currentItem.partNo && !currentItem.partName && !currentItem.details;
            };

            const handleAddItem = () => {
                if (!currentItem.assignee || !currentItem.startDate || !currentItem.dueDate) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return;
                }
                setPendingItems(prev => [...prev, { ...currentItem, tempId: Date.now().toString() + Math.random().toString().slice(2) }]);
                setCurrentItem({ ...currentItem, partNo: '', partName: '', details: '' }); 
            };

            const handleSubmitAll = () => {
                if (!topic || !meetingDate) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°'); return; }
                let finalItems = [...pendingItems];
                const hasValidInput = currentItem.assignee && currentItem.startDate && currentItem.dueDate;
                
                if (hasValidInput && !isResidueInput()) {
                    finalItems.push({ ...currentItem, tempId: Date.now().toString() + Math.random().toString().slice(2) });
                }

                if (finalItems.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }

                const tasks = finalItems.map((item, index) => ({
                    id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9) + '-' + index,
                    topic, meetingDate, ...item,
                    status: 'active', completedAt: '', createdAt: new Date().toISOString()
                }));
                onSubmit(tasks);
                setTopic(''); setPendingItems([]); onClose();
            };

            const hasValidInput = currentItem.assignee && currentItem.startDate && currentItem.dueDate;
            const willAddCurrent = hasValidInput && !isResidueInput();
            const totalCount = pendingItems.length + (willAddCurrent ? 1 : 0);

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-blue-600 px-6 py-4 flex justify-between items-center text-white">
                            <h3 className="font-semibold text-lg flex items-center gap-2"><Icon name="Plus" className="w-5 h-5"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h3>
                            <button onClick={onClose}><Icon name="X" className="w-6 h-6"/></button>
                        </div>
                        <div className="flex flex-col md:flex-row h-full overflow-hidden">
                            <div className="w-full md:w-5/12 p-6 overflow-y-auto border-r border-gray-100 bg-gray-50/50">
                                <h4 className="font-bold text-gray-800 mb-4">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
                                <div className="space-y-4">
                                    <div><label className="text-sm font-medium text-gray-700">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ *</label><input value={topic} onChange={e=>setTopic(e.target.value)} className="w-full p-2 border rounded-lg" /></div>
                                    <div><label className="text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° *</label><input type="date" value={meetingDate} onChange={e=>setMeetingDate(e.target.value)} className="w-full p-2 border rounded-lg" /></div>
                                </div>
                                <hr className="my-4"/>
                                <h4 className="font-bold text-gray-800 mb-4">2. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h4>
                                <div className="space-y-3">
                                    <input placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö *" value={currentItem.assignee} onChange={e=>setCurrentItem({...currentItem, assignee: e.target.value})} className="w-full p-2 border rounded-lg text-sm" />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input placeholder="Part No." value={currentItem.partNo} onChange={e=>setCurrentItem({...currentItem, partNo: e.target.value})} className="w-full p-2 border rounded-lg text-sm" />
                                        <input placeholder="Part Name" value={currentItem.partName} onChange={e=>setCurrentItem({...currentItem, partName: e.target.value})} className="w-full p-2 border rounded-lg text-sm" />
                                    </div>
                                    <div className="grid grid-cols-1 gap-2">
                                        <div>
                                            <label className="text-xs font-bold text-gray-700">‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤)</label>
                                            <input type="datetime-local" value={currentItem.startDate} onChange={e=>setCurrentItem({...currentItem, startDate: e.target.value})} className="w-full p-2 border rounded-lg text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-red-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á (‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤)</label>
                                            <input type="datetime-local" value={currentItem.dueDate} onChange={e=>setCurrentItem({...currentItem, dueDate: e.target.value})} className="w-full p-2 border rounded-lg text-sm" />
                                        </div>
                                    </div>
                                    <textarea placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value={currentItem.details} onChange={e=>setCurrentItem({...currentItem, details: e.target.value})} rows="2" className="w-full p-2 border rounded-lg text-sm"></textarea>
                                    <button onClick={handleAddItem} className="w-full py-2 bg-gray-800 text-white rounded-lg text-sm flex justify-center items-center gap-2"><Icon name="ListPlus" className="w-4 h-4"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button>
                                </div>
                            </div>
                            <div className="w-full md:w-7/12 flex flex-col bg-white">
                                <div className="p-4 bg-gray-50 border-b flex justify-between"><h4 className="font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ({pendingItems.length})</h4></div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                    {pendingItems.map((item, idx) => (
                                        <div key={item.tempId} className="flex gap-3 p-3 border rounded-lg bg-white shadow-sm">
                                            <span className="font-bold text-blue-600 bg-blue-50 w-6 h-6 rounded-full flex items-center justify-center text-xs">{idx+1}</span>
                                            <div className="flex-1 text-sm">
                                                <div className="font-semibold">{item.assignee}</div>
                                                <div className="text-xs text-gray-500">{item.partNo} {item.partName}</div>
                                                <div className="text-xs text-blue-600 mt-1">‡∏™‡πà‡∏á: {new Date(item.dueDate).toLocaleString('th-TH')}</div>
                                            </div>
                                            <button onClick={()=>setPendingItems(prev=>prev.filter(i=>i.tempId!==item.tempId))} className="text-red-400"><Icon name="Trash2" className="w-4 h-4"/></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="p-4 border-t flex justify-end gap-2">
                                    <button onClick={onClose} className="px-4 py-2 text-gray-600">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button onClick={handleSubmitAll} disabled={isSaving} className="px-6 py-2 bg-blue-600 text-white rounded-lg shadow-lg flex items-center gap-2">
                                        {isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : <><Icon name="CheckCircle" className="w-4 h-4"/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({totalCount})</>}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        function App() {
            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null); // For detail view
            
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');

            const [deletedLocalIds, setDeletedLocalIds] = useState(() => {
                const saved = localStorage.getItem('deletedLocalIds');
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('deletedLocalIds', JSON.stringify(deletedLocalIds));
            }, [deletedLocalIds]);

            const fetchTasks = async () => {
                if (API_URL.includes("‡∏ß‡∏≤‡∏á_URL_‡∏¢‡∏≤‡∏ß‡πÜ")) { 
                    console.log("Waiting for API URL...");
                    setIsLoading(false); 
                    return; 
                } 
                
                setIsLoading(true);
                try {
                    const res = await fetch(API_URL);
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        const safeData = data
                            .filter(item => {
                                const status = String(item.status || '').toLowerCase().trim();
                                return status !== 'archived';
                            })
                            .map((item, index) => ({
                                ...item,
                                id: (item.id && String(item.id).trim() !== '') ? String(item.id) : `no-id-${index}`
                            }))
                            .filter(item => !deletedLocalIds.includes(item.id));
                            
                        setTasks(safeData.reverse());
                    }
                } catch (error) {
                    console.error("Error fetching:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { fetchTasks(); }, []);

            const handleAddTasks = async (newTasks) => {
                setIsSaving(true);
                setTasks(prev => [...newTasks, ...prev]);

                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'create', tasks: newTasks })
                    });
                    setTimeout(fetchTasks, 2000); 
                } catch (error) {
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                } finally {
                    setIsSaving(false);
                }
            };

            const handleArchiveTask = async (id) => {
                const isNoId = String(id).startsWith('no-id-');
                
                if (!window.confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                
                setTasks(prev => prev.filter(t => t.id !== id));
                
                if (isNoId) {
                    setDeletedLocalIds(prev => [...prev, id]);
                    return;
                }

                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'update', id: id, updates: { status: 'archived' } })
                });
            };

            const handleToggleComplete = async (task) => {
                const newStatus = task.status === 'completed' ? 'active' : 'completed';
                const completedAt = newStatus === 'completed' ? new Date().toISOString() : '';
                const isNoId = String(task.id).startsWith('no-id-');
                
                if (isNoId) {
                    setDeletedLocalIds(prev => [...prev, task.id]);
                    setTasks(prev => prev.filter(t => t.id !== task.id)); // Hide old

                    const newTask = {
                        ...task,
                        id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                        status: newStatus,
                        completedAt: completedAt
                    };

                    setTasks(prev => [newTask, ...prev]);

                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'create', tasks: [newTask] })
                    });
                    return;
                }

                setTasks(prev => prev.map(t => String(t.id) === String(task.id) ? { ...t, status: newStatus, completedAt } : t));
                
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'update', id: task.id, updates: { status: newStatus, completedAt: completedAt } })
                });
            };

            const stats = useMemo(() => {
                const now = new Date(); now.setHours(0,0,0,0);
                let c = { all: 0, normal: 0, nearDue: 0, overdue: 0, completed: 0 };
                tasks.forEach(t => {
                    const status = String(t.status || '').toLowerCase();
                    if (status === 'archived') return; 
                    
                    c.all++;
                    if (status === 'completed') { c.completed++; return; }
                    const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                    const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) c.overdue++; else if (diffDays <= 3) c.nearDue++; else c.normal++;
                });
                return c;
            }, [tasks]);

            const filteredTasks = tasks.filter(t => {
                const status = String(t.status || '').toLowerCase();
                if (status === 'archived') return false; 
                
                const matches = (t.topic+t.assignee+t.partNo+t.partName).toLowerCase().includes(searchTerm.toLowerCase());
                if (filterStatus === 'all') return matches;
                if (filterStatus === 'completed') return matches && status === 'completed';
                return matches && status !== 'completed';
            });

            const getStatusInfo = (t) => {
                if (t.status === 'completed') return { bg: 'bg-green-50', text: 'text-green-700', border: 'border-green-200', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' };
                const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                const diff = Math.ceil((due - new Date().setHours(0,0,0,0)) / (86400000));
                if (diff < 0) return { bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200', label: `‡πÄ‡∏•‡∏¢ ${Math.abs(diff)} ‡∏ß‡∏±‡∏ô` };
                if (diff <= 3) return { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200', label: `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${diff} ‡∏ß‡∏±‡∏ô` };
                return { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200', label: '‡∏õ‡∏Å‡∏ï‡∏¥' };
            };

            const formatDateTime = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('th-TH', { 
                    day: 'numeric', month: 'short', year: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                });
            };
            
            const formatDateOnly = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('th-TH', { 
                    day: 'numeric', month: 'short', year: '2-digit'
                });
            };

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900 p-6 md:p-8 relative">
                    {/* Loading Overlay */}
                    {isLoading && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center loading-overlay">
                            <div className="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center">
                                <Icon name="Loader" className="w-10 h-10 text-blue-600 animate-spin mb-3" />
                                <p className="text-gray-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                            </div>
                        </div>
                    )}

                    {API_URL.includes("‡∏ß‡∏≤‡∏á_URL_‡∏¢‡∏≤‡∏ß‡πÜ") && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-center shadow-md animate-pulse">
                            <p className="font-bold text-lg">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet!</p>
                            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå index.html ‡∏î‡πâ‡∏ß‡∏¢ Notepad ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥ URL ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 37</p>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between mb-8 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Meeting Dashboard <span className="text-sm font-normal text-green-600 bg-green-100 px-2 py-1 rounded-full ml-2">Online</span></h1>
                            <p className="text-gray-500 mt-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets (‡∏•‡∏ö = ‡∏ã‡πà‡∏≠‡∏ô)</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={fetchTasks} className="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2.5 rounded-lg shadow-sm flex items-center gap-2">
                                <Icon name="Refresh" className={`w-5 h-5 ${isLoading ? 'animate-spin' : ''}`} /> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                            </button>
                            <button onClick={() => setIsAddModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-lg flex items-center gap-2 font-medium">
                                <Icon name="Plus" className="w-5 h-5" /> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                        <StatCard title="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" count={stats.all} type="default" />
                        <StatCard title="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" count={stats.completed} type="green" iconName="CheckCircle" />
                        <StatCard title="‡∏õ‡∏Å‡∏ï‡∏¥" count={stats.normal} type="blue" iconName="Clock" />
                        <StatCard title="‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î" count={stats.nearDue} type="yellow" iconName="AlertTriangle" />
                        <StatCard title="‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î" count={stats.overdue} type="red" iconName="AlertCircle" />
                    </div>

                    {/* Filter */}
                    <div className="bg-white p-2 rounded-xl border shadow-sm mb-6 flex flex-col md:flex-row gap-3">
                        <div className="relative flex-1">
                            <div className="absolute left-3 top-2.5 text-gray-400"><Icon name="Search" className="w-5 h-5"/></div>
                            <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-lg border-none outline-none" />
                        </div>
                        <div className="h-8 w-px bg-gray-200 hidden md:block"></div>
                        <select value={filterStatus} onChange={e=>setFilterStatus(e.target.value)} className="bg-transparent font-medium outline-none px-2">
                            <option value="all">üìÅ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="active">‚ö° ‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</option>
                            <option value="completed">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
                        </select>
                    </div>

                    {/* List */}
                    <div className="bg-white rounded-2xl shadow-sm border min-h-[400px] p-6">
                        {filteredTasks.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-64 text-gray-400">
                                <Icon name="Inbox" className="w-12 h-12 mb-2 opacity-50" />
                                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {filteredTasks.map(task => {
                                    const s = getStatusInfo(task);
                                    const isNoId = String(task.id).startsWith('no-id-');
                                    
                                    return (
                                        <div key={task.id} className={`group flex flex-col md:flex-row md:items-center justify-between p-4 rounded-xl border hover:shadow-md transition-all ${task.status==='completed' ? 'bg-gray-50 opacity-75' : 'bg-white'}`}>
                                            <div className="flex gap-4 flex-1">
                                                <div className="flex flex-col gap-2 items-center">
                                                    <button onClick={()=>handleToggleComplete(task)} className={`w-10 h-10 rounded-lg flex items-center justify-center transition-all flex-shrink-0 ${task.status==='completed' ? 'bg-green-500 text-white' : 'border-2 text-gray-300 hover:border-blue-500'}`}>
                                                        <Icon name="Check" className="w-6 h-6" />
                                                    </button>
                                                    {isNoId && (
                                                        <span className="w-2 h-2 rounded-full bg-orange-400 animate-pulse" title="‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡πà‡∏≤ (‡πÑ‡∏°‡πà‡∏°‡∏µ ID) - ‡∏ï‡∏¥‡πä‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ"></span>
                                                    )}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <h3 className={`font-bold text-lg truncate ${task.status==='completed'?'line-through text-gray-500':''}`}>{task.topic}</h3>
                                                    <div className="flex flex-wrap gap-2 mt-2 text-sm text-gray-600">
                                                        <span className="flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded-md"><Icon name="User" className="w-4 h-4"/> {task.assignee}</span>
                                                        {(task.partNo || task.partName) && <span className="flex items-center gap-1 bg-gray-100 px-2 py-0.5 rounded-md"><Icon name="Tag" className="w-4 h-4"/> {task.partNo} {task.partName}</span>}
                                                        <span className="flex items-center gap-1 text-blue-600 bg-blue-50 px-2 py-0.5 rounded-md"><Icon name="CalendarDays" className="w-4 h-4"/> {formatDateOnly(task.meetingDate)}</span>
                                                    </div>
                                                    
                                                    {/* NEW: Prominent Date Display */}
                                                    <div className="mt-3 flex flex-wrap gap-2 items-center">
                                                        <div className="flex items-center gap-1 bg-gray-50 border border-gray-200 px-3 py-1.5 rounded-lg">
                                                            <div className="text-xs text-gray-500 uppercase tracking-wide font-semibold">Start</div>
                                                            <div className="font-bold text-gray-700 ml-1">{formatDateTime(task.startDate)}</div>
                                                        </div>
                                                        <Icon name="ArrowRight" className="w-4 h-4 text-gray-300" />
                                                        <div className="flex items-center gap-1 bg-red-50 border border-red-100 px-3 py-1.5 rounded-lg">
                                                            <div className="text-xs text-red-500 uppercase tracking-wide font-semibold">Due</div>
                                                            <div className="font-bold text-red-700 ml-1">{formatDateTime(task.dueDate)}</div>
                                                        </div>
                                                    </div>

                                                    {task.details && <p className="text-sm text-gray-400 mt-2 line-clamp-1">{task.details}</p>}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4 mt-4 md:mt-0">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold border ${s.bg} ${s.text} ${s.border}`}>{s.label}</span>
                                                
                                                {/* View Detail Button */}
                                                <button onClick={() => setSelectedTask(task)} title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" className="text-gray-400 hover:text-blue-600 hover:bg-blue-50 p-2 rounded-full transition-colors">
                                                    <Icon name="Eye" className="w-5 h-5"/>
                                                </button>

                                                <button onClick={()=>handleArchiveTask(task.id)} title="‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏•‡∏ö)" className="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <Icon name="Trash2" className="w-5 h-5"/>
                                                </button>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </div>

                    <AddTaskModal isOpen={isAddModalOpen} onClose={()=>setIsAddModalOpen(false)} onSubmit={handleAddTasks} isSaving={isSaving} />
                    <TaskDetailModal task={selectedTask} onClose={() => setSelectedTask(null)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
